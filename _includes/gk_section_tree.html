{%- assign depth = include.depth | default: 0 -%}
{%- assign grouped = include.items | group_by_exp: "p", "p.gk_section | split: '/' | slice: depth, 1 | first" -%}
{%- assign next_depth = depth | plus: 1 -%}

{%- for group in grouped -%}
  {%- if group.name != nil and group.name != "" -%}
<h{{ depth | plus: 2 }}>{{ group.name }}</h{{ depth | plus: 2 }}>
  {%- assign has_leaf = false -%}
  {%- for p in group.items -%}
    {%- assign parts_size = p.gk_section | split: '/' | size -%}
    {%- if parts_size == next_depth -%}
      {%- if has_leaf == false -%}
<ul>
        {%- assign has_leaf = true -%}
      {%- endif -%}
  <li><a href="{{ p.url | relative_url }}">{{ p.title }}</a></li>
    {%- endif -%}
  {%- endfor -%}
  {%- if has_leaf -%}
</ul>
  {%- endif -%}

  {%- assign has_deeper = false -%}
  {%- for p in group.items -%}
    {%- assign parts_size = p.gk_section | split: '/' | size -%}
    {%- if parts_size > next_depth -%}
      {%- assign has_deeper = true -%}
    {%- endif -%}
  {%- endfor -%}
  {%- if has_deeper -%}
    {% include gk_section_tree.html items=group.items depth=next_depth %}
  {%- endif -%}
  {%- endif -%}
{%- endfor -%}
