{%- assign depth = include.depth | default: 0 -%}
{%- assign next_depth = depth | plus: 1 -%}

{% comment %} 現在の階層にあるサブカテゴリ名を抽出 {% endcomment %}
{%- assign sub_names = "" -%}
{%- for p in include.items -%}
  {%- assign parts = p.gk_section | split: '/' -%}
  {%- if parts.size > next_depth -%}
    {%- capture sub_names -%}{{ sub_names }}|{{ parts[next_depth] }}{%- endcapture -%}
  {%- endif -%}
{%- endfor -%}
{%- assign unique_subs = sub_names | remove_first: "|" | split: "|" | uniq | sort -%}

{% comment %} 1. この階層に直属するページ（記事）を表示 {% endcomment %}
<ul>
{%- for p in include.items -%}
  {%- assign parts = p.gk_section | split: '/' -%}
  {%- if parts.size == next_depth -%}
    <li><a href="{{ p.url | relative_url }}">{{ p.title }}</a></li>
  {%- endif -%}
{%- endfor -%}
</ul>

{% comment %} 2. 下位階層（サブセクション）があれば再帰的に表示 {% endcomment %}
{%- for sub_name in unique_subs -%}
  <h{{ depth | plus: 3 }}>{{ sub_name }}</h{{ depth | plus: 3 }}>
  
  {%- assign sub_items = "" | split: "" -%}
  {%- for p in include.items -%}
    {%- assign parts = p.gk_section | split: '/' -%}
    {%- if parts[next_depth] == sub_name -%}
      {%- assign sub_items = sub_items | push: p -%}
    {%- endif -%}
  {%- endfor -%}
  
  {% include gk_section_tree.html items=sub_items depth=next_depth %}
{%- endfor -%}